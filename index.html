<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ãŠç”³ã—è¾¼ã¿</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root {
      --primary: #6c5ce7;
      --line-color: #06C755;
      --bg: #f4f7f9;
      --text: #2d3436;
    }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: var(--bg);
      padding: 15px;
      color: var(--text);
      line-height: 1.5;
    }
    h2 { text-align: center; color: var(--primary); font-size: 1.3rem; margin-bottom: 20px; }
    .section-title { 
      font-weight: bold; 
      margin: 25px 0 10px; 
      border-left: 5px solid var(--primary); 
      padding-left: 10px; 
      font-size: 1rem;
    }
    .card { 
      background: white; 
      border-radius: 18px; 
      padding: 20px; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.08); 
      margin-bottom: 25px; 
    }
    
    label { display: block; font-size: 0.85rem; margin-bottom: 6px; color: #555; font-weight: 600; }
    .must { color: #e74c3c; margin-left: 4px; font-size: 0.8rem; }
    
    .flex { display: flex; gap: 10px; }
    .flex > div { flex: 1; }
    
    input, select, textarea { 
      width: 100%; 
      padding: 14px; 
      margin-bottom: 18px; 
      border: 1px solid #ddd; 
      border-radius: 10px; 
      box-sizing: border-box; 
      font-size: 1rem;
      background-color: #fafafa;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      background-color: #fff;
    }
    
    .btn-submit { 
      width: 100%; 
      padding: 18px; 
      background: var(--line-color); 
      color: white; 
      border: none; 
      border-radius: 50px; 
      font-size: 1.1rem; 
      font-weight: bold; 
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(6, 199, 85, 0.3);
      transition: all 0.2s;
    }
    .btn-submit:active { transform: scale(0.97); opacity: 0.9; }

    .note { font-size: 0.75rem; color: #888; text-align: center; margin-top: 10px; }
  </style>
</head>
<body>

<h2>ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³è©³ç´°è¨­å®š ğŸŒ™</h2>

<div class="card">
  <div class="section-title">å®‰å¦ç¢ºèªã®è¨­å®š</div>
  <label>é€ä»˜å¸Œæœ›æ™‚é–“ï¼ˆ1æ™‚é–“åˆ»ã¿ï¼‰<span class="must">*</span></label>
  <select id="send_time" required></select>

  <div class="section-title">ã”æœ¬äººæ§˜æƒ…å ±</div>
  <label>ãŠåå‰ï¼ˆæ¼¢å­—ï¼‰<span class="must">*</span></label>
  <div class="flex">
    <input type="text" id="user_last_name" placeholder="è‹—å­—" required>
    <input type="text" id="user_first_name" placeholder="åå‰" required>
  </div>
  
  <label>ãƒ•ãƒªã‚¬ãƒŠï¼ˆã‚«ã‚¿ã‚«ãƒŠï¼‰<span class="must">*</span></label>
  <div class="flex">
    <input type="text" id="user_last_kana" placeholder="ãƒŸãƒ§ã‚¦ã‚¸" required pattern="^[ã‚¡-ãƒ¶ãƒ¼]+$">
    <input type="text" id="user_first_kana" placeholder="ãƒŠãƒã‚¨" required pattern="^[ã‚¡-ãƒ¶ãƒ¼]+$">
  </div>

  <label>ã”ä½æ‰€<span class="must">*</span></label>
  <textarea id="user_address" rows="2" placeholder="æ±äº¬éƒ½æ¸¯åŒº..." required></textarea>
  
  <label>é›»è©±ç•ªå·<span class="must">*</span></label>
  <input type="tel" id="user_tel" placeholder="09012345678" required>
  
  <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹<span class="must">*</span></label>
  <input type="email" id="user_email" placeholder="example@mail.com" required>

  <div class="section-title">ç·Šæ€¥é€£çµ¡å…ˆ</div>
  <label>ç¶šæŸ„ï¼ˆã”æœ¬äººã‹ã‚‰è¦‹ã¦ï¼‰<span class="must">*</span></label>
  <select id="emergency_rel" required>
    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
    <option value="å¤«ãƒ»å¦»">å¤«ãƒ»å¦»</option>
    <option value="æ¯å­">æ¯å­</option>
    <option value="å¨˜">å¨˜</option>
    <option value="çˆ¶ãƒ»æ¯">çˆ¶ãƒ»æ¯</option>
    <option value="å…„å¼Ÿãƒ»å§‰å¦¹">å…„å¼Ÿãƒ»å§‰å¦¹</option>
    <option value="è¦ªæˆš">è¦ªæˆš</option>
    <option value="å‹äººãƒ»çŸ¥äºº">å‹äººãƒ»çŸ¥äºº</option>
    <option value="ãã®ä»–">ãã®ä»–</option>
  </select>

  <label>ãŠåå‰ï¼ˆãƒ•ãƒ«ãƒãƒ¼ãƒ ï¼‰<span class="must">*</span></label>
  <input type="text" id="emergency_name" placeholder="å±±ç”° ä¸€éƒ" required>
  
  <label>LINE ID<span class="must">*</span></label>
  <input type="text" id="emergency_line" placeholder="é€£çµ¡å…ˆã®LINE ID" required>
  
  <label>é›»è©±ç•ªå·<span class="must">*</span></label>
  <input type="tel" id="emergency_tel" placeholder="08012345678" required>
  
  <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹<span class="must">*</span></label>
  <input type="email" id="emergency_email" placeholder="family@mail.com" required>

  <label>ã”ä½æ‰€ï¼ˆä»»æ„ï¼‰</label>
  <textarea id="emergency_address" rows="2" placeholder="ã”æœ¬äººæ§˜ã¨ç•°ãªã‚‹å ´åˆãªã©"></textarea>
</div>

<button class="btn-submit" onclick="submitForm()">ä¿å­˜ã—ã¦æ±ºæ¸ˆã¸é€²ã‚€</button>
<p class="note">â€»æ±ºæ¸ˆå®Œäº†å¾Œã«ã‚µãƒ¼ãƒ“ã‚¹ãŒé–‹å§‹ã•ã‚Œã¾ã™</p>

<script>
// --- â˜… å„è‡ªã®è¨­å®šã«åˆã‚ã›ã¦æ›¸ãæ›ãˆã¦ãã ã•ã„ â˜… ---
const LIFF_ID = "ã‚ãªãŸã®LIFF_ID"; 
const MAKE_WEBHOOK_URL = "ã‚ãªãŸã®Makeç”¨WebhookURL"; 
const STRIPE_URL = "ã‚ãªãŸã®Stripeãƒªãƒ³ã‚¯"; 

// 1. æ™‚é–“ã®é¸æŠè‚¢ã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹ï¼ˆ1æ™‚é–“åˆ»ã¿ï¼‰
function generateTimeOptions() {
  const select = document.getElementById('send_time');
  const interval = 60; // 60åˆ†(1æ™‚é–“)åˆ»ã¿

  for (let minutes = 0; minutes < 24 * 60; minutes += interval) {
    const h = Math.floor(minutes / 60);
    const m = minutes % 60;
    const timeString = h.toString().padStart(2, '0') + ":" + m.toString().padStart(2, '0');

    const option = document.createElement('option');
    option.value = timeString;
    option.textContent = timeString;
    if (timeString === "08:00") option.selected = true; // åˆæœŸå€¤
    select.appendChild(option);
  }
}

// 2. LIFFã®åˆæœŸåŒ–
async function initLIFF() {
  try {
    await liff.init({ liffId: LIFF_ID });
    generateTimeOptions();
    if (!liff.isLoggedIn()) {
      liff.login();
    }
  } catch (err) {
    console.error("LIFFåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", err);
  }
}

// 3. ãƒ‡ãƒ¼ã‚¿ã®é€ä¿¡ã¨é·ç§»
async function submitForm() {
  const profile = await liff.getProfile();
  
  const formData = {
    userId: profile.userId,
    sendTime: document.getElementById('send_time').value,
    userLastName: document.getElementById('user_last_name').value,
    userFirstName: document.getElementById('user_first_name').value,
    userLastKana: document.getElementById('user_last_kana').value,
    userFirstKana: document.getElementById('user_first_kana').value,
    userAddress: document.getElementById('user_address').value,
    userTel: document.getElementById('user_tel').value,
    userEmail: document.getElementById('user_email').value,
    emergencyRel: document.getElementById('emergency_rel').value,
    emergencyName: document.getElementById('emergency_name').value,
    emergencyLine: document.getElementById('emergency_line').value,
    emergencyTel: document.getElementById('emergency_tel').value,
    emergencyEmail: document.getElementById('emergency_email').value,
    emergencyAddress: document.getElementById('emergency_address').value,
  };

  // ç°¡æ˜“ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  if(!formData.userLastName || !formData.emergencyLine) {
    alert("æœªå…¥åŠ›ã®å¿…é ˆé …ç›®ãŒã‚ã‚Šã¾ã™");
    return;
  }

  try {
    // Make.comã¸é€ä¿¡
    await fetch(MAKE_WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(formData)
    });

    // Stripeã¸é·ç§»
    window.location.href = `${STRIPE_URL}?client_reference_id=${profile.userId}`;
    
  } catch (e) {
    alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
  }
}

initLIFF();
</script>

</body>
</html>
